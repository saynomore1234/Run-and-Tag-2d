import pygame
import random
import sys

# Initialize Pygame
pygame.init()

# Constants
SCREEN_WIDTH, SCREEN_HEIGHT = 800, 600
GREEN = (34, 177, 76)
BLACK = (0, 0, 0)
GRAY = (200, 200, 200)
FPS = 60

# Screen setup
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Run and Tag Game")
clock = pygame.time.Clock()

# Fonts
font = pygame.font.Font(None, 36)

def draw_text(text, font, color, surface, x, y):
    textobj = font.render(text, True, color)
    textrect = textobj.get_rect()
    textrect.center = (x, y)
    surface.blit(textobj, textrect)

def draw_button(text, font, color, surface, x, y, width, height):
    button_rect = pygame.Rect(x, y, width, height)
    pygame.draw.rect(surface, color, button_rect)
    pygame.draw.rect(surface, BLACK, button_rect, 2)  # Black border for visibility
    draw_text(text, font, BLACK, surface, x + width // 2, y + height // 2)
    return button_rect

# Player class
class Player(pygame.sprite.Sprite):
    def __init__(self):
        super().__init__()
        self.image = pygame.Surface((30, 30))
        self.image.fill(BLACK)
        self.rect = self.image.get_rect(center=(SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2))
        self.speed = 5

    def update(self, obstacles):
        keys = pygame.key.get_pressed()
        dx, dy = 0, 0
        if keys[pygame.K_LEFT]:
            dx = -self.speed
        if keys[pygame.K_RIGHT]:
            dx = self.speed
        if keys[pygame.K_UP]:
            dy = -self.speed
        if keys[pygame.K_DOWN]:
            dy = self.speed
        
        self.rect.x += dx
        self.rect.clamp_ip(screen.get_rect())  # Prevent going out of bounds
        if pygame.sprite.spritecollideany(self, obstacles):
            self.rect.x -= dx
        
        self.rect.y += dy
        self.rect.clamp_ip(screen.get_rect())
        if pygame.sprite.spritecollideany(self, obstacles):
            self.rect.y -= dy

# Chaser class
class Chaser(pygame.sprite.Sprite):
    def __init__(self, player):
        super().__init__()
        self.image = pygame.Surface((30, 30))
        self.image.fill(BLACK)
        self.rect = self.image.get_rect(center=(random.randint(0, SCREEN_WIDTH), random.randint(0, SCREEN_HEIGHT)))
        self.speed = 4
        self.player = player

    def update(self, obstacles):
        if self.rect.x < self.player.rect.x:
            self.rect.x += self.speed
        elif self.rect.x > self.player.rect.x:
            self.rect.x -= self.speed
        if self.rect.y < self.player.rect.y:
            self.rect.y += self.speed
        elif self.rect.y > self.player.rect.y:
            self.rect.y -= self.speed

# Obstacle class
class Obstacle(pygame.sprite.Sprite):
    def __init__(self):
        super().__init__()
        self.image = pygame.Surface((50, 50))
        self.image.fill(GRAY)
        self.rect = self.image.get_rect(center=(random.randint(50, SCREEN_WIDTH-50), random.randint(50, SCREEN_HEIGHT-50)))
        pygame.draw.rect(self.image, BLACK, self.image.get_rect(), 2)  # Black border

# Game over screen with buttons and keyboard options
def game_over_screen():
    screen.fill(GREEN)
    restart_button = draw_button('Restart', font, GRAY, screen, SCREEN_WIDTH // 2 - 150, SCREEN_HEIGHT // 2, 100, 50)
    quit_button = draw_button('Quit', font, GRAY, screen, SCREEN_WIDTH // 2 + 50, SCREEN_HEIGHT // 2, 100, 50)
    pygame.display.update()

    while True:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            elif event.type == pygame.MOUSEBUTTONDOWN:
                mouse_pos = pygame.mouse.get_pos()
                if restart_button.collidepoint(mouse_pos):
                    return  # Exit the game_over_screen function and restart the game
                elif quit_button.collidepoint(mouse_pos):
                    pygame.quit()
                    sys.exit()
            elif event.type == pygame.KEYDOWN:
                if event.key == pygame.K_r:
                    return  # Exit the game_over_screen function and restart the game
                elif event.key == pygame.K_q:
                    pygame.quit()
                    sys.exit()

# Game loop
def game_loop():
    running = True
    while running:
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
                pygame.quit()
                sys.exit()

        all_sprites.update(obstacles)
        if pygame.sprite.collide_rect(player, chaser):
            game_over_screen()

        screen.fill(GREEN)
        all_sprites.draw(screen)
        pygame.display.flip()
        clock.tick(FPS)

# Create sprite groups and start game
player = Player()
chaser = Chaser(player)
obstacles = pygame.sprite.Group()
for _ in range(10):
    obstacles.add(Obstacle())
all_sprites = pygame.sprite.Group(player, chaser, *obstacles)

if __name__ == "__main__":
    game_loop()
